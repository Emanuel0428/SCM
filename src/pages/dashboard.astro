---
import Layout from '../layouts/Layout.astro';
import StockChart from '../components/StockChart.astro';
import MovimientosChart from '../components/MovimientosChart.astro';
---
<Layout>
  <div class="flex flex-col w-full p-6 gap-6">
    <div class="flex justify-between items-center">
      <h1 class="text-4xl font-extrabold text-blue-900 drop-shadow">Dashboard</h1>
      
      <!-- Filtros -->
      <div class="flex gap-4 items-center">
        <div class="flex items-center gap-2">
          <label class="font-semibold text-blue-900 text-sm">Empresa:</label>
          <select 
            id="filtro-empresa-dashboard" 
            class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400 outline-none transition hover:border-gray-400 bg-white text-sm"
          >
            <option value="">Todas</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <label class="font-semibold text-blue-900 text-sm">Per√≠odo:</label>
          <select 
            id="filtro-periodo" 
            class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400 outline-none transition hover:border-gray-400 bg-white text-sm"
          >
            <option value="7">√öltimos 7 d√≠as</option>
            <option value="30" selected>√öltimos 30 d√≠as</option>
            <option value="90">√öltimos 90 d√≠as</option>
            <option value="365">√öltimo a√±o</option>
            <option value="all">Todo</option>
          </select>
        </div>
        <button 
          id="btn-actualizar-dashboard"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold transition shadow-md text-sm"
        >
          üîÑ Actualizar
        </button>
      </div>
    </div>

    <!-- Tarjetas de Resumen -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm opacity-80">Total Activos</p>
            <p id="stat-total-activos" class="text-3xl font-bold mt-2">0</p>
          </div>
          <div class="text-5xl opacity-50">üì¶</div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm opacity-80">Ingresos (per√≠odo)</p>
            <p id="stat-ingresos" class="text-3xl font-bold mt-2">0</p>
          </div>
          <div class="text-5xl opacity-50">üì•</div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm opacity-80">Egresos (per√≠odo)</p>
            <p id="stat-egresos" class="text-3xl font-bold mt-2">0</p>
          </div>
          <div class="text-5xl opacity-50">üì§</div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm opacity-80">Garant√≠as por Vencer</p>
            <p id="stat-garantias" class="text-3xl font-bold mt-2">0</p>
          </div>
          <div class="text-5xl opacity-50">‚ö†Ô∏è</div>
        </div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="grid md:grid-cols-2 gap-6">
      <div class="bg-white/90 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4 text-blue-900">Distribuci√≥n de Activos</h2>
        <StockChart />
      </div>
      <div class="bg-white/90 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4 text-blue-900">Movimientos en el Tiempo</h2>
        <MovimientosChart />
      </div>
    </div>

    <!-- Tablas de Detalles -->
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Top Productos con M√°s Movimientos -->
      <div class="bg-white/90 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4 text-blue-900">Top Productos con M√°s Movimientos</h2>
        <div class="overflow-auto max-h-80">
          <table class="min-w-full text-sm">
            <thead class="bg-blue-50 sticky top-0">
              <tr>
                <th class="px-4 py-2 text-left text-blue-900">#</th>
                <th class="px-4 py-2 text-left text-blue-900">Producto</th>
                <th class="px-4 py-2 text-center text-blue-900">Movimientos</th>
              </tr>
            </thead>
            <tbody id="tabla-top-productos" class="divide-y divide-gray-200">
              <!-- Datos din√°micos -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- √öltimos Movimientos -->
      <div class="bg-white/90 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4 text-blue-900">√öltimos Movimientos</h2>
        <div class="overflow-auto max-h-80">
          <table class="min-w-full text-sm">
            <thead class="bg-blue-50 sticky top-0">
              <tr>
                <th class="px-3 py-2 text-left text-blue-900">Fecha</th>
                <th class="px-3 py-2 text-left text-blue-900">Producto</th>
                <th class="px-3 py-2 text-center text-blue-900">Tipo</th>
                <th class="px-3 py-2 text-right text-blue-900">Cant.</th>
              </tr>
            </thead>
            <tbody id="tabla-ultimos-movimientos" class="divide-y divide-gray-200">
              <!-- Datos din√°micos -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Alertas -->
    <div class="bg-white/90 rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-bold mb-4 text-blue-900">‚ö†Ô∏è Alertas de Inventario</h2>
      <div id="contenedor-alertas" class="space-y-2">
        <!-- Datos din√°micos -->
      </div>
    </div>
  </div>

  <script>
    // Funciones para obtener datos desde localStorage
    function getActivos() {
      const data = localStorage.getItem('scm_activos');
      return data ? JSON.parse(data) : [];
    }

    function getMovimientos() {
      const data = localStorage.getItem('scm_movimientos');
      return data ? JSON.parse(data) : [];
    }

    function getVariantes() {
      const data = localStorage.getItem('scm_variantes');
      return data ? JSON.parse(data) : [];
    }

    function getModelos() {
      const data = localStorage.getItem('scm_modelos');
      return data ? JSON.parse(data) : [];
    }

    function getMarcas() {
      const data = localStorage.getItem('scm_marcas');
      return data ? JSON.parse(data) : [];
    }

    function getEmpresas() {
      const data = localStorage.getItem('scm_empresas');
      return data ? JSON.parse(data) : [];
    }

    function getTiposMovimiento() {
      const data = localStorage.getItem('scm_tipos_movimiento');
      return data ? JSON.parse(data) : [];
    }

    let empresaFiltro = '';
    let periodoFiltro: number | string = 30;

    // Renderizar filtros
    function renderFiltros() {
      const selectEmpresa = document.getElementById('filtro-empresa-dashboard') as HTMLSelectElement;
      if (!selectEmpresa) return;

      const empresas = getEmpresas();
      const firstOption = selectEmpresa.querySelector('option');
      selectEmpresa.innerHTML = '';
      if (firstOption) selectEmpresa.appendChild(firstOption);

      empresas.forEach((e: any) => {
        const opt = document.createElement('option');
        opt.value = e.id;
        opt.textContent = e.nombre;
        if (e.id === empresaFiltro) opt.selected = true;
        selectEmpresa.appendChild(opt);
      });
    }

    // Filtrar por fecha
    function estaEnPeriodo(fecha: string): boolean {
      if (periodoFiltro === 'all') return true;
      const fechaMov = new Date(fecha);
      const hoy = new Date();
      const dias = typeof periodoFiltro === 'string' ? parseInt(periodoFiltro) : periodoFiltro;
      const limiteInferior = new Date(hoy.getTime() - (dias * 24 * 60 * 60 * 1000));
      return fechaMov >= limiteInferior;
    }

    // Calcular estad√≠sticas
    function calcularEstadisticas() {
      const activos = getActivos();
      const movimientos = getMovimientos();
      const variantes = getVariantes();
      const modelos = getModelos();
      const tipos = getTiposMovimiento();

      // Filtrar activos por empresa si hay filtro
      let activosFiltrados = activos;
      if (empresaFiltro) {
        activosFiltrados = activos.filter((a: any) => {
          const variante = variantes.find((v: any) => v.id === a.variante_id);
          const modelo = modelos.find((m: any) => m.id === variante?.modelo_id);
          return modelo && modelo.empresa_id === empresaFiltro;
        });
      }

      // Filtrar movimientos por empresa y per√≠odo
      let movimientosFiltrados = movimientos.filter((m: any) => estaEnPeriodo(m.ocurrido_el));
      if (empresaFiltro) {
        movimientosFiltrados = movimientosFiltrados.filter((m: any) => {
          const variante = variantes.find((v: any) => v.id === m.variante_id);
          const modelo = modelos.find((mod: any) => mod.id === variante?.modelo_id);
          return modelo && modelo.empresa_id === empresaFiltro;
        });
      }

      // Total de activos
      const totalActivos = activosFiltrados.length;

      // Ingresos (ENTRADA)
      const ingresos = movimientosFiltrados.filter((m: any) => m.tipo_mov_id === 1).length;

      // Egresos (SALIDA)
      const egresos = movimientosFiltrados.filter((m: any) => m.tipo_mov_id === 2).length;

      // Garant√≠as pr√≥ximas a vencer (pr√≥ximos 30 d√≠as)
      const hoy = new Date();
      const limite30Dias = new Date(hoy.getTime() + (30 * 24 * 60 * 60 * 1000));
      const garantiasVencer = activosFiltrados.filter((a: any) => {
        if (!a.garantia_hasta) return false;
        const garantia = new Date(a.garantia_hasta);
        return garantia > hoy && garantia <= limite30Dias;
      }).length;

      // Actualizar stats en el DOM
      const statActivos = document.getElementById('stat-total-activos');
      const statIngresos = document.getElementById('stat-ingresos');
      const statEgresos = document.getElementById('stat-egresos');
      const statGarantias = document.getElementById('stat-garantias');

      if (statActivos) statActivos.textContent = totalActivos.toString();
      if (statIngresos) statIngresos.textContent = ingresos.toString();
      if (statEgresos) statEgresos.textContent = egresos.toString();
      if (statGarantias) statGarantias.textContent = garantiasVencer.toString();
    }

    // Renderizar Top Productos
    function renderTopProductos() {
      const tbody = document.getElementById('tabla-top-productos');
      if (!tbody) return;

      const movimientos = getMovimientos();
      const variantes = getVariantes();
      const modelos = getModelos();
      const marcas = getMarcas();

      // Contar movimientos por variante
      const conteo: Record<string, number> = {};
      movimientos.forEach((m: any) => {
        if (m.variante_id) {
          conteo[m.variante_id] = (conteo[m.variante_id] || 0) + 1;
        }
      });

      // Ordenar por cantidad de movimientos
      const top = Object.entries(conteo)
        .sort(([, a], [, b]) => (b as number) - (a as number))
        .slice(0, 10);

      tbody.innerHTML = '';

      if (top.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="px-4 py-4 text-center text-gray-500">
              No hay movimientos registrados
            </td>
          </tr>
        `;
        return;
      }

      top.forEach(([varianteId, cantidad], index) => {
        const variante = variantes.find((v: any) => v.id === varianteId);
        const modelo = modelos.find((m: any) => m.id === variante?.modelo_id);
        const marca = marcas.find((ma: any) => ma.id === modelo?.marca_id);

        const nombre = [marca?.nombre, modelo?.modelo, variante?.color]
          .filter(Boolean)
          .join(' ');

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-blue-50 transition';
        tr.innerHTML = `
          <td class="px-4 py-3 text-center font-bold text-blue-600">${index + 1}</td>
          <td class="px-4 py-3">${nombre}</td>
          <td class="px-4 py-3 text-center">
            <span class="px-2 py-1 rounded-full bg-blue-100 text-blue-800 font-semibold">
              ${cantidad}
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Renderizar √öltimos Movimientos
    function renderUltimosMovimientos() {
      const tbody = document.getElementById('tabla-ultimos-movimientos');
      if (!tbody) return;

      let movimientos = getMovimientos();
      const variantes = getVariantes();
      const modelos = getModelos();
      const marcas = getMarcas();
      const tipos = getTiposMovimiento();

      // Filtrar por per√≠odo
      movimientos = movimientos.filter((m: any) => estaEnPeriodo(m.ocurrido_el));

      // Filtrar por empresa si hay filtro activo
      if (empresaFiltro) {
        movimientos = movimientos.filter((m: any) => {
          const variante = variantes.find((v: any) => v.id === m.variante_id);
          const modelo = modelos.find((mod: any) => mod.id === variante?.modelo_id);
          return modelo && modelo.empresa_id === empresaFiltro;
        });
      }

      // Ordenar por fecha descendente
      movimientos.sort((a: any, b: any) => 
        new Date(b.ocurrido_el).getTime() - new Date(a.ocurrido_el).getTime()
      );

      // Tomar solo los √∫ltimos 10
      movimientos = movimientos.slice(0, 10);

      tbody.innerHTML = '';

      if (movimientos.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="px-3 py-4 text-center text-gray-500">
              No hay movimientos en este per√≠odo
            </td>
          </tr>
        `;
        return;
      }

      movimientos.forEach((mov: any) => {
        const variante = variantes.find((v: any) => v.id === mov.variante_id);
        const modelo = modelos.find((m: any) => m.id === variante?.modelo_id);
        const marca = marcas.find((ma: any) => ma.id === modelo?.marca_id);
        const tipo = tipos.find((t: any) => t.id === mov.tipo_mov_id);

        const nombre = [marca?.nombre, modelo?.modelo, variante?.color]
          .filter(Boolean)
          .join(' ');

        const fecha = new Date(mov.ocurrido_el);
        const tipoClase = 
          tipo?.codigo === 'ENTRADA' ? 'bg-green-100 text-green-800' :
          tipo?.codigo === 'SALIDA' ? 'bg-red-100 text-red-800' :
          'bg-blue-100 text-blue-800';

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-blue-50 transition';
        tr.innerHTML = `
          <td class="px-3 py-2">${fecha.toLocaleDateString()}</td>
          <td class="px-3 py-2">${nombre || 'N/A'}</td>
          <td class="px-3 py-2 text-center">
            <span class="px-2 py-1 rounded-full text-xs font-semibold ${tipoClase}">
              ${tipo?.codigo || 'N/A'}
            </span>
          </td>
          <td class="px-3 py-2 text-right font-semibold">${mov.cantidad}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Renderizar Alertas
    function renderAlertas() {
      const contenedor = document.getElementById('contenedor-alertas');
      if (!contenedor) return;

      let activos = getActivos();
      const variantes = getVariantes();
      const modelos = getModelos();
      const marcas = getMarcas();

      // Filtrar por empresa
      if (empresaFiltro) {
        activos = activos.filter((a: any) => {
          const variante = variantes.find((v: any) => v.id === a.variante_id);
          const modelo = modelos.find((m: any) => m.id === variante?.modelo_id);
          return modelo && modelo.empresa_id === empresaFiltro;
        });
      }

      const hoy = new Date();
      const alertas: any[] = [];

      // Garant√≠as vencidas
      activos.forEach((a: any) => {
        if (a.garantia_hasta) {
          const garantia = new Date(a.garantia_hasta);
          const diasRestantes = Math.ceil((garantia.getTime() - hoy.getTime()) / (1000 * 60 * 60 * 24));
          
          const variante = variantes.find((v: any) => v.id === a.variante_id);
          const modelo = modelos.find((m: any) => m.id === variante?.modelo_id);
          const marca = marcas.find((ma: any) => ma.id === modelo?.marca_id);
          const nombre = [marca?.nombre, modelo?.modelo, a.etiqueta].filter(Boolean).join(' ');

          if (diasRestantes < 0) {
            alertas.push({
              tipo: 'error',
              mensaje: `${nombre}: Garant√≠a vencida hace ${Math.abs(diasRestantes)} d√≠as`
            });
          } else if (diasRestantes <= 30) {
            alertas.push({
              tipo: 'warning',
              mensaje: `${nombre}: Garant√≠a vence en ${diasRestantes} d√≠as`
            });
          }
        }
      });

      contenedor.innerHTML = '';

      if (alertas.length === 0) {
        contenedor.innerHTML = `
          <div class="flex items-center gap-3 bg-green-50 border-2 border-green-200 rounded-lg p-4">
            <span class="text-3xl">‚úì</span>
            <p class="text-green-800 font-semibold">No hay alertas. Todo est√° en orden.</p>
          </div>
        `;
        return;
      }

      alertas.forEach((alerta: any) => {
        const div = document.createElement('div');
        const clases = alerta.tipo === 'error' 
          ? 'bg-red-50 border-red-200 text-red-800'
          : 'bg-yellow-50 border-yellow-200 text-yellow-800';
        div.className = `flex items-center gap-3 border-2 rounded-lg p-3 ${clases}`;
        div.innerHTML = `
          <span class="text-2xl">${alerta.tipo === 'error' ? 'üî¥' : '‚ö†Ô∏è'}</span>
          <p class="font-semibold text-sm">${alerta.mensaje}</p>
        `;
        contenedor.appendChild(div);
      });
    }

    // Actualizar todo el dashboard
    function actualizarDashboard() {
      calcularEstadisticas();
      renderTopProductos();
      renderUltimosMovimientos();
      renderAlertas();
      
      // Disparar evento para que los gr√°ficos se actualicen
      window.dispatchEvent(new CustomEvent('dashboard-actualizado'));
    }

    // Event listeners
    document.getElementById('filtro-empresa-dashboard')?.addEventListener('change', (e) => {
      empresaFiltro = (e.target as HTMLSelectElement).value;
      actualizarDashboard();
    });

    document.getElementById('filtro-periodo')?.addEventListener('change', (e) => {
      periodoFiltro = (e.target as HTMLSelectElement).value;
      actualizarDashboard();
    });

    document.getElementById('btn-actualizar-dashboard')?.addEventListener('click', () => {
      actualizarDashboard();
    });

    // Escuchar cambios en los datos
    window.addEventListener('scm-data-changed', () => {
      actualizarDashboard();
    });

    window.addEventListener('storage', () => {
      actualizarDashboard();
    });

    // Inicializar
    renderFiltros();
    actualizarDashboard();
  </script>
</Layout>
