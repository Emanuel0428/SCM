---
import { empresas, sedes, ubicaciones, variantes, modelos, marcas, tipos_movimiento } from '../data/mockData';

// Props para filtrar por tipo de movimiento
interface Props {
  tipo?: 'ingreso' | 'egreso' | 'todos';
}

const { tipo = 'todos' } = Astro.props;

// Filtrar tipos de movimiento seg√∫n el tipo de p√°gina
let tiposPermitidos = tipos_movimiento;
if (tipo === 'ingreso') {
  tiposPermitidos = tipos_movimiento.filter(t => t.codigo === 'ENTRADA');
} else if (tipo === 'egreso') {
  tiposPermitidos = tipos_movimiento.filter(t => t.codigo === 'SALIDA' || t.codigo === 'TRASLADO');
}
---
<div class="w-full flex flex-col gap-8" id="movimientos-container" data-tipo={tipo}>
  <form id="form-movimiento" class="bg-white/90 rounded-xl shadow-lg p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
    <input type="hidden" name="id" id="movimiento-id" />
    
    <div class="flex flex-col">
      <label class="font-semibold text-blue-900 mb-1">
        Tipo Movimiento <span class="text-red-500">*</span>
      </label>
      <select
        name="tipo_mov_id"
        id="tipo-mov-id"
        required
        class="border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-500 outline-none transition hover:border-gray-400 bg-white"
      >
        <option value="">Seleccione...</option>
        {tiposPermitidos.map((t: any) => (
          <option value={t.id}>{t.codigo}</option>
        ))}
      </select>
    </div>

    <div class="flex flex-col">
      <label class="font-semibold text-blue-900 mb-1">
        Elemento <span class="text-red-500">*</span>
      </label>
      <select
        name="variante_id"
        id="variante-id-mov"
        required
        class="border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-500 outline-none transition hover:border-gray-400 bg-white"
      >
        <option value="">Seleccione...</option>
        <!-- Opciones pobladas din√°micamente desde localStorage y window.__SCM_INIT -->
      </select>
    </div>

    <div class="flex flex-col">
      <label class="font-semibold text-blue-900 mb-1">Sede Origen</label>
      <select
        name="sede_desde_id"
        id="sede-desde-id"
        class="border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-500 outline-none transition hover:border-gray-400 bg-white"
      >
        <option value="">N/A</option>
        {sedes.map((s: any) => (
          <option value={s.id}>{s.nombre}</option>
        ))}
      </select>
    </div>

    <div class="flex flex-col">
      <label class="font-semibold text-blue-900 mb-1">Ubicaci√≥n Origen</label>
      <select
        name="ubic_desde_id"
        id="ubic-desde-id"
        class="border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-500 outline-none transition hover:border-gray-400 bg-white"
      >
        <option value="">N/A</option>
        {ubicaciones.map((u: any) => (
          <option value={u.id}>{u.codigo} ({u.tipo})</option>
        ))}
      </select>
    </div>

    <div class="flex flex-col">
      <label class="font-semibold text-blue-900 mb-1">
        Sede Destino <span class="text-red-500">*</span>
      </label>
      <select
        name="sede_hacia_id"
        id="sede-hacia-id"
        required
        class="border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-500 outline-none transition hover:border-gray-400 bg-white"
      >
        <option value="">Seleccione...</option>
        {sedes.map((s: any) => (
          <option value={s.id}>{s.nombre}</option>
        ))}
      </select>
    </div>

    <div class="flex flex-col">
      <label class="font-semibold text-blue-900 mb-1">
        Ubicaci√≥n Destino <span class="text-red-500">*</span>
      </label>
      <select
        name="ubic_hacia_id"
        id="ubic-hacia-id"
        required
        class="border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-500 outline-none transition hover:border-gray-400 bg-white"
      >
        <option value="">Seleccione...</option>
        {ubicaciones.map((u: any) => (
          <option value={u.id}>{u.codigo} ({u.tipo})</option>
        ))}
      </select>
    </div>

    <div class="flex flex-col">
      <label class="font-semibold text-blue-900 mb-1">
        Cantidad <span class="text-red-500">*</span>
      </label>
      <input 
        type="number"
        name="cantidad"
        id="cantidad"
        required
        min="1"
        step="1"
        class="border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-500 outline-none transition hover:border-gray-400 bg-white"
        placeholder="Ingrese cantidad"
      />
    </div>

    <div class="flex flex-col md:col-span-2">
      <label class="font-semibold text-blue-900 mb-1">Motivo</label>
      <input 
        type="text"
        name="motivo"
        id="motivo"
        class="border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-500 outline-none transition hover:border-gray-400 bg-white"
        placeholder="Describa el motivo del movimiento"
      />
    </div>

    <div class="col-span-1 sm:col-span-2 md:col-span-3 mt-4 text-center flex gap-2 justify-center">
      <button 
        type="submit" 
        id="btn-submit-mov"
        class="bg-gradient-to-r from-blue-600 to-blue-400 text-white px-6 py-2 rounded-lg font-bold shadow hover:scale-105 hover:from-blue-700 hover:to-blue-500 transition"
      >
        {tipo === 'ingreso' ? 'üì• Registrar Ingreso' : tipo === 'egreso' ? 'üì§ Registrar Egreso' : 'Registrar Movimiento'}
      </button>
      <button 
        type="button" 
        id="btn-cancel-mov"
        class="bg-gray-500 text-white px-6 py-2 rounded-lg font-bold shadow hover:scale-105 hover:bg-gray-600 transition hidden"
      >
        Cancelar
      </button>
    </div>
  </form>

  <div class="overflow-x-auto rounded-lg shadow-lg bg-white/80 backdrop-blur max-w-full">
    <table class="min-w-full divide-y divide-blue-100">
      <thead class="sticky top-0">
        <tr class="bg-gradient-to-r from-blue-600 to-blue-400 text-white whitespace-nowrap">
          <th class="px-4 py-3 text-sm">Tipo</th>
          <th class="px-4 py-3 text-sm">Elemento</th>
          <th class="px-4 py-3 text-sm">Color</th>
          <th class="px-4 py-3 text-sm">Origen</th>
          <th class="px-4 py-3 text-sm">Destino</th>
          <th class="px-4 py-3 text-sm">Cantidad</th>
          <th class="px-4 py-3 text-sm">Fecha</th>
          <th class="px-4 py-3 text-sm">Motivo</th>
          <th class="px-4 py-3 text-sm">Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-movimientos" class="divide-y divide-blue-50">
        <!-- Los datos se cargar√°n din√°micamente -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de √©xito -->
<div id="modal-mov-success" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-8 max-w-sm w-full mx-4 text-center shadow-2xl relative">
    <div class="text-green-600 text-5xl mb-4">‚úì</div>
    <h3 class="text-xl font-bold text-blue-900 mb-2">¬°√âxito!</h3>
    <p id="modal-mov-success-msg" class="text-gray-700 mb-6">Operaci√≥n completada correctamente.</p>
    <button id="modal-mov-success-ok" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold transition">
      Aceptar
    </button>
  </div>
</div>

<!-- Modal de confirmaci√≥n para eliminar -->
<div id="modal-mov-confirm" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center shadow-2xl relative">
    <div class="text-yellow-600 text-5xl mb-4">‚ö†Ô∏è</div>
    <h3 class="text-xl font-bold text-blue-900 mb-2">¬øConfirmar anulaci√≥n?</h3>
    <p class="text-gray-700 mb-6">¬øEst√° seguro de anular este movimiento? Esta acci√≥n no se puede deshacer.</p>
    <div class="flex gap-4">
      <button id="modal-mov-confirm-yes" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 font-semibold transition">
        S√≠, anular
      </button>
      <button id="modal-mov-confirm-no" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold transition">
        Cancelar
      </button>
    </div>
  </div>
</div>

  <script set:html={`window.__SCM_INIT = ${JSON.stringify({ modelos, variantes, marcas, sedes, ubicaciones, tipos_movimiento })};`}></script>

  <script>
  // Funciones para modales
  function showSuccess(mensaje: string) {
    const modal = document.getElementById('modal-mov-success');
    const msgEl = document.getElementById('modal-mov-success-msg');
    if (modal && msgEl) {
      msgEl.textContent = mensaje;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }, 2500);
    }
  }

  let confirmCallback: (() => void) | null = null;

  function showConfirmDelete(callback: () => void) {
    const modal = document.getElementById('modal-mov-confirm');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      confirmCallback = callback;
    }
  }

  function hideConfirmDelete() {
    const modal = document.getElementById('modal-mov-confirm');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    confirmCallback = null;
  }

  // Event listeners para modales
  document.getElementById('modal-mov-success-ok')?.addEventListener('click', () => {
    const modal = document.getElementById('modal-mov-success');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  });

  document.getElementById('modal-mov-confirm-yes')?.addEventListener('click', () => {
    hideConfirmDelete();
    if (confirmCallback) {
      confirmCallback();
    }
  });

  document.getElementById('modal-mov-confirm-no')?.addEventListener('click', () => {
    hideConfirmDelete();
  });

  // Funciones para obtener datos din√°micamente desde localStorage
  function getModelos() {
    const data = localStorage.getItem('scm_modelos');
    return data ? JSON.parse(data) : ((window as any).__SCM_INIT?.modelos || []);
  }

  function getMarcas() {
    const data = localStorage.getItem('scm_marcas');
    return data ? JSON.parse(data) : ((window as any).__SCM_INIT?.marcas || []);
  }

  function getSedes() {
    const data = localStorage.getItem('scm_sedes');
    return data ? JSON.parse(data) : ((window as any).__SCM_INIT?.sedes || []);
  }

  function getUbicaciones() {
    const data = localStorage.getItem('scm_ubicaciones');
    return data ? JSON.parse(data) : ((window as any).__SCM_INIT?.ubicaciones || []);
  }

  function getTiposMovimiento() {
    const data = localStorage.getItem('scm_tipos_movimiento');
    return data ? JSON.parse(data) : ((window as any).__SCM_INIT?.tipos_movimiento || []);
  }

  function getVariantes() {
    const data = localStorage.getItem('scm_variantes');
    return data ? JSON.parse(data) : ((window as any).__SCM_INIT?.variantes || []);
  }
  function getActivos() {
    const data = localStorage.getItem('scm_activos');
    return data ? JSON.parse(data) : [];
  }
  
  function initMovimientos() {
    // Inicializar sedes si no existen
    if (!localStorage.getItem('scm_sedes')) {
      localStorage.setItem('scm_sedes', JSON.stringify((window as any).__SCM_INIT?.sedes || []));
    }

    // Inicializar ubicaciones si no existen
    if (!localStorage.getItem('scm_ubicaciones')) {
      localStorage.setItem('scm_ubicaciones', JSON.stringify((window as any).__SCM_INIT?.ubicaciones || []));
    }

    // Inicializar tipos de movimiento si no existen
    if (!localStorage.getItem('scm_tipos_movimiento')) {
      localStorage.setItem('scm_tipos_movimiento', JSON.stringify((window as any).__SCM_INIT?.tipos_movimiento || []));
    }

    // Inicializar movimientos si no existen
    if (!localStorage.getItem('scm_movimientos')) {
      const movimientosIniciales = [
        {
          id: '1',
          empresa_id: '1',
          tipo_mov_id: 1,
          ocurrido_el: '2024-01-10T10:00:00Z',
          realizado_por: null,
          sede_desde_id: null,
          ubic_desde_id: null,
          sede_hacia_id: '1',
          ubic_hacia_id: '1',
          activo_id: null,
          variante_id: '1',
          codigo_lote: null,
          cantidad: 5,
          motivo: 'Compra inicial de laptops HP',
          ref_tabla: null,
          ref_id: null
        },
        {
          id: '2',
          empresa_id: '1',
          tipo_mov_id: 3,
          ocurrido_el: '2024-02-20T11:30:00Z',
          realizado_por: null,
          sede_desde_id: '1',
          ubic_desde_id: '1',
          sede_hacia_id: '2',
          ubic_hacia_id: '2',
          activo_id: null,
          variante_id: '1',
          codigo_lote: null,
          cantidad: 2,
          motivo: 'Traslado de equipos a sede secundaria',
          ref_tabla: null,
          ref_id: null
        }
      ];
      localStorage.setItem('scm_movimientos', JSON.stringify(movimientosIniciales));
    }
  }

  function getMovimientos() {
    const data = localStorage.getItem('scm_movimientos');
    return data ? JSON.parse(data) : [];
  }

  function saveMovimientos(movimientos: any[]) {
    localStorage.setItem('scm_movimientos', JSON.stringify(movimientos));
  }

  function renderVariantesSelect() {
    const select = document.getElementById('variante-id-mov');
    if (!select) return;
    const variantesArr = getVariantes();
    const modelos = getModelos();
    const marcas = getMarcas();
    const firstOption = select.querySelector('option');
    select.innerHTML = '';
    if (firstOption) select.appendChild(firstOption);
    const activos = getActivos();
    variantesArr.forEach((v: any) => {
      const opt = document.createElement('option');
      opt.value = v.id;
      const modelo = modelos.find((m: any) => m.id === v.modelo_id);
      const marca = modelo ? marcas.find((ma: any) => ma.id === modelo.marca_id) : null;
      // Si existe un activo con esta variante, incluir su etiqueta en el label (nombre del activo)
      const activoMatch = activos.find((a: any) => a.variante_id === v.id);
      const parts = [];
      if (marca?.nombre) parts.push(marca.nombre);
      if (modelo?.modelo) parts.push(modelo.modelo);
      if (activoMatch?.etiqueta) parts.push(activoMatch.etiqueta);
      let label = parts.join(' ');
      const variantParts = [];
      if (v.color) variantParts.push(v.color);
      if (v.talla) variantParts.push(v.talla);
      if (variantParts.length) label += ` - ${variantParts.join(' / ')}`;
      opt.textContent = label.trim();
      select.appendChild(opt);
    });
  }

  function renderTablaMovimientos() {
    const tbody = document.getElementById('tabla-movimientos');
    if (!tbody) return;

    const container = document.getElementById('movimientos-container');
    const tipoFiltro = container?.getAttribute('data-tipo') || 'todos';
    
    let movimientos = getMovimientos();
    const variantes = getVariantes();
    const modelos = getModelos();
    const marcas = getMarcas();
    const sedes = getSedes();
    const ubicaciones = getUbicaciones();
    const tipos_movimiento = getTiposMovimiento();
    
    // Filtrar movimientos seg√∫n el tipo de p√°gina
    if (tipoFiltro === 'ingreso') {
      movimientos = movimientos.filter((m: any) => m.tipo_mov_id === 1); // ENTRADA
    } else if (tipoFiltro === 'egreso') {
      movimientos = movimientos.filter((m: any) => m.tipo_mov_id === 2 || m.tipo_mov_id === 3); // SALIDA o TRASLADO
    }
    
    tbody.innerHTML = '';

    movimientos.forEach((mov: any) => {
      const variante = variantes.find((v: any) => v.id === mov.variante_id);
      const modelo = variante ? modelos.find((m: any) => m.id === variante.modelo_id) : null;
      const marca = modelo ? marcas.find((ma: any) => ma.id === modelo.marca_id) : null;
      const sedeDesde = mov.sede_desde_id ? sedes.find((s: any) => s.id === mov.sede_desde_id) : null;
      const ubicDesde = mov.ubic_desde_id ? ubicaciones.find((u: any) => u.id === mov.ubic_desde_id) : null;
  const sedeHacia = sedes.find((s: any) => s.id === mov.sede_hacia_id);
  const ubicHacia = ubicaciones.find((u: any) => u.id === mov.ubic_hacia_id);
      const tipo = tipos_movimiento.find((t: any) => t.id === mov.tipo_mov_id);

      const fecha = new Date(mov.ocurrido_el);

      const tr = document.createElement('tr');
      tr.className = 'hover:bg-blue-50 transition';
  // Construir label combinado para el elemento (Marca Modelo [Etiqueta] - Variante)
  const activos = getActivos();
  const activoMatch = activos.find((a: any) => a.variante_id === mov.variante_id);
  const elementoLabelParts = [];
  if (marca?.nombre) elementoLabelParts.push(marca.nombre);
  if (modelo?.modelo) elementoLabelParts.push(modelo.modelo);
  if (activoMatch?.etiqueta) elementoLabelParts.push(activoMatch.etiqueta);
  let elementoLabel = elementoLabelParts.join(' ');
  const varParts = [];
  if (variante?.color) varParts.push(variante.color);
  if (variante?.talla) varParts.push(variante.talla);
  if (varParts.length) elementoLabel += ` - ${varParts.join(' / ')}`;

      tr.innerHTML = `
        <td class="px-4 py-2 text-sm whitespace-nowrap">
          <span class="px-2 py-1 rounded-full text-xs ${
            tipo?.codigo === 'ENTRADA' 
              ? 'bg-green-100 text-green-800'
              : tipo?.codigo === 'SALIDA'
              ? 'bg-red-100 text-red-800'
              : 'bg-blue-100 text-blue-800'
          }">
            ${tipo?.codigo || 'DESCONOCIDO'}
          </span>
        </td>
  <td class="px-4 py-2 text-sm whitespace-nowrap">${elementoLabel}</td>
  <td class="px-4 py-2 text-sm whitespace-nowrap">${variante?.color || 'N/A'}</td>
  <td class="px-4 py-2 text-sm whitespace-nowrap">${sedeDesde && ubicDesde ? `${sedeDesde.nombre} - ${ubicDesde.codigo}` : 'N/A'}</td>
  <td class="px-4 py-2 text-sm whitespace-nowrap">${sedeHacia && ubicHacia ? `${sedeHacia.nombre} - ${ubicHacia.codigo}` : 'N/A'}</td>
        <td class="px-4 py-2 text-sm whitespace-nowrap">${mov.cantidad}</td>
        <td class="px-4 py-2 text-sm whitespace-nowrap">${fecha.toLocaleString()}</td>
        <td class="px-4 py-2 text-sm whitespace-nowrap max-w-[200px] truncate">${mov.motivo}</td>
        <td class="px-4 py-2 text-sm whitespace-nowrap">
          <div class="flex gap-1">
            <button class="btn-editar-mov bg-yellow-400 hover:bg-yellow-500 text-white px-2 py-1 rounded text-xs" data-id="${mov.id}">
              Editar
            </button>
            <button class="btn-anular bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" data-id="${mov.id}">
              Anular
            </button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Agregar event listeners
    document.querySelectorAll('.btn-editar-mov').forEach(btn => {
      btn.addEventListener('click', handleEditarMov);
    });
    document.querySelectorAll('.btn-anular').forEach(btn => {
      btn.addEventListener('click', handleAnular);
    });
  }

  function handleEditarMov(e: any) {
    const id = (e.target).getAttribute('data-id');
    const movimientos = getMovimientos();
    const mov = movimientos.find((m: any) => m.id === id);
    
    if (mov) {
      (document.getElementById('movimiento-id') as HTMLInputElement).value = mov.id;
      (document.getElementById('tipo-mov-id') as HTMLSelectElement).value = mov.tipo_mov_id.toString();
      (document.getElementById('variante-id-mov') as HTMLSelectElement).value = mov.variante_id;
      (document.getElementById('sede-desde-id') as HTMLSelectElement).value = mov.sede_desde_id || '';
      (document.getElementById('ubic-desde-id') as HTMLSelectElement).value = mov.ubic_desde_id || '';
      (document.getElementById('sede-hacia-id') as HTMLSelectElement).value = mov.sede_hacia_id;
      (document.getElementById('ubic-hacia-id') as HTMLSelectElement).value = mov.ubic_hacia_id;
      (document.getElementById('cantidad') as HTMLInputElement).value = mov.cantidad.toString();
      (document.getElementById('motivo') as HTMLTextAreaElement).value = mov.motivo || '';

      (document.getElementById('btn-submit-mov') as HTMLButtonElement).textContent = 'Actualizar Movimiento';
      (document.getElementById('btn-cancel-mov') as HTMLButtonElement).classList.remove('hidden');
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function handleAnular(e: any) {
    const id = (e.target).getAttribute('data-id');
    showConfirmDelete(() => {
      const movimientos = getMovimientos();
      const filtered = movimientos.filter((m: any) => m.id !== id);
      saveMovimientos(filtered);
      renderTablaMovimientos();
      showSuccess('Movimiento anulado correctamente');
    });
  }

  // Form submit
  const formMov = document.getElementById('form-movimiento');
  formMov?.addEventListener('submit', (e: any) => {
    e.preventDefault();

    const formData = new FormData(e.target as HTMLFormElement);
    const id = formData.get('id');
    const tipo_mov_id = parseInt(String(formData.get('tipo_mov_id')));
    const variante_id = String(formData.get('variante_id'));
    const sede_desde_id = formData.get('sede_desde_id') ? String(formData.get('sede_desde_id')) : undefined;
    const ubic_desde_id = formData.get('ubic_desde_id') ? String(formData.get('ubic_desde_id')) : undefined;
    const sede_hacia_id = String(formData.get('sede_hacia_id'));
    const ubic_hacia_id = String(formData.get('ubic_hacia_id'));
    const cantidad = parseInt(String(formData.get('cantidad')));
    const motivo = String(formData.get('motivo'));
    
    const movimientos = getMovimientos();
    
    if (id) {
      // Actualizar
      const index = movimientos.findIndex((m: any) => m.id === id);
      if (index !== -1) {
        movimientos[index] = {
          ...movimientos[index],
          tipo_mov_id,
          variante_id,
          sede_desde_id,
          ubic_desde_id,
          sede_hacia_id,
          ubic_hacia_id,
          cantidad,
          motivo
        };
        showSuccess('Movimiento actualizado correctamente');
      }
    } else {
      // Crear
      const newMovimiento = {
        id: Date.now().toString(),
        empresa_id: '1',
        tipo_mov_id,
        variante_id,
        sede_desde_id,
        ubic_desde_id,
        sede_hacia_id,
        ubic_hacia_id,
        cantidad,
        motivo,
        ocurrido_el: new Date().toISOString()
      };
      movimientos.push(newMovimiento);
      showSuccess('Movimiento registrado correctamente');
    }
    
    saveMovimientos(movimientos);
    const formTarget = e.target as HTMLFormElement;
    if (formTarget) formTarget.reset();
    const movIdInput = document.getElementById('movimiento-id') as HTMLInputElement;
    if (movIdInput) movIdInput.value = '';
    const btnSubmit = document.getElementById('btn-submit-mov') as HTMLButtonElement;
    if (btnSubmit) btnSubmit.textContent = 'Registrar Movimiento';
    const btnCancel = document.getElementById('btn-cancel-mov') as HTMLButtonElement;
    if (btnCancel) btnCancel.classList.add('hidden');
    renderTablaMovimientos();
  });

  // Cancelar edici√≥n
  document.getElementById('btn-cancel-mov')?.addEventListener('click', () => {
    const formMovimiento = document.getElementById('form-movimiento') as HTMLFormElement;
    if (formMovimiento) formMovimiento.reset();
    const movIdInput = document.getElementById('movimiento-id') as HTMLInputElement;
    if (movIdInput) movIdInput.value = '';
    const btnSubmit = document.getElementById('btn-submit-mov') as HTMLButtonElement;
    if (btnSubmit) btnSubmit.textContent = 'Registrar Movimiento';
    const btnCancel = document.getElementById('btn-cancel-mov') as HTMLButtonElement;
    if (btnCancel) btnCancel.classList.add('hidden');
  });

  // Inicializar
  initMovimientos();
  // Rellenar select de variantes desde la cache antes de renderizar tabla
  renderVariantesSelect();
  renderTablaMovimientos();

  // Escuchar cambios en la cache (mismo tab u otras pesta√±as)
  window.addEventListener('scm-data-changed', (e: any) => {
    const key = e.detail?.key;
    if (!key) return;
    if (['scm_variantes', 'scm_modelos', 'scm_marcas'].includes(key)) {
      renderVariantesSelect();
      renderTablaMovimientos();
    }
  });

  window.addEventListener('storage', (e) => {
    if (!e.key) return;
    if (['scm_variantes', 'scm_modelos', 'scm_marcas'].includes(e.key)) {
      renderVariantesSelect();
      renderTablaMovimientos();
    }
  });
</script>
