---
import { empresas as empresasIniciales } from '../data/mockData';
---
<div class="bg-white/90 rounded-xl shadow-lg p-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-blue-900">Gestión de Empresas</h2>
    <button id="btn-nueva-empresa" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold transition shadow-md flex items-center gap-2">
      <span class="text-xl">+</span>
      <span>Nueva Empresa</span>
    </button>
  </div>

  <!-- Tabla de Empresas -->
  <div class="overflow-x-auto rounded-lg shadow-md">
    <table class="min-w-full bg-white divide-y divide-gray-200">
      <thead class="bg-gradient-to-r from-blue-600 to-blue-400 text-white">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-semibold">Nombre</th>
          <th class="px-6 py-3 text-left text-sm font-semibold">NIT</th>
          <th class="px-6 py-3 text-left text-sm font-semibold">Sedes</th>
          <th class="px-6 py-3 text-left text-sm font-semibold">Items</th>
          <th class="px-6 py-3 text-left text-sm font-semibold">Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-empresas" class="divide-y divide-gray-200">
        <!-- Se llenará dinámicamente -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal para crear/editar empresa -->
<div id="modal-empresa" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 shadow-2xl relative">
    <button id="modal-empresa-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold">×</button>
    
    <h3 id="modal-empresa-title" class="text-2xl font-bold text-blue-900 mb-6">Nueva Empresa</h3>
    
    <form id="form-empresa-modal" class="space-y-4">
      <input type="hidden" id="empresa-modal-id" />
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="col-span-2">
          <label class="block text-sm font-semibold text-blue-900 mb-2">
            Nombre de la Empresa <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="empresa-modal-nombre" 
            required 
            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-400 outline-none transition hover:border-gray-400"
            placeholder="Ej: Empresa Demo S.A.S."
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-blue-900 mb-2">
            NIT <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="empresa-modal-nit" 
            required 
            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-400 outline-none transition hover:border-gray-400"
            placeholder="123456789-0"
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-blue-900 mb-2">
            NIT Normalizado (solo números)
          </label>
          <input 
            type="text" 
            id="empresa-modal-nit-norm" 
            class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 bg-gray-100"
            placeholder="Se calcula automáticamente"
            readonly
          />
        </div>
      </div>

      <div class="flex gap-4 mt-6">
        <button 
          type="submit" 
          class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold transition shadow-md"
        >
          Guardar Empresa
        </button>
        <button 
          type="button" 
          id="btn-cancelar-empresa"
          class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold transition shadow-md"
        >
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div id="modal-confirmar-eliminar" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
    <div class="text-red-600 text-5xl mb-4">⚠️</div>
    <h3 class="text-xl font-bold text-blue-900 mb-4">¿Confirmar eliminación?</h3>
    <p class="text-gray-700 mb-6">Esta acción no se puede deshacer. Se eliminará la empresa y todas sus relaciones.</p>
    <div class="flex gap-4">
      <button 
        id="btn-confirmar-eliminar" 
        class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 font-semibold transition"
      >
        Eliminar
      </button>
      <button 
        id="btn-cancelar-eliminar" 
        class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold transition"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal de éxito -->
<div id="modal-exito-empresa" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-8 max-w-sm w-full mx-4 text-center shadow-2xl relative">
    <div class="text-green-600 text-5xl mb-4">✓</div>
    <h3 class="text-xl font-bold text-blue-900 mb-2">¡Éxito!</h3>
    <p id="modal-exito-empresa-msg" class="text-gray-700 mb-6">Operación completada correctamente.</p>
    <button id="modal-exito-empresa-ok" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold transition">
      Aceptar
    </button>
  </div>
</div>

<!-- Inyectar datos iniciales -->
<script set:html={`window.__SCM_EMPRESAS_INIT = ${JSON.stringify({ empresas: empresasIniciales })};`}></script>

<script>
  // Funciones para gestionar empresas
  function getEmpresas() {
    const data = localStorage.getItem('scm_empresas');
    if (data) return JSON.parse(data);
    try { 
      return (window as any).__SCM_EMPRESAS_INIT?.empresas || []; 
    } catch (err) { 
      return []; 
    }
  }

  function saveEmpresas(empresas: any[]) {
    localStorage.setItem('scm_empresas', JSON.stringify(empresas));
    window.dispatchEvent(new CustomEvent('scm-data-changed', { detail: { key: 'scm_empresas' } }));
  }

  function getSedes() {
    const data = localStorage.getItem('scm_sedes');
    return data ? JSON.parse(data) : [];
  }

  function getModelos() {
    const data = localStorage.getItem('scm_modelos');
    return data ? JSON.parse(data) : [];
  }

  function normalizarNIT(nit: string): string {
    return nit.replace(/[^0-9]/g, '');
  }

  function showModal(modalId: string) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
  }

  function hideModal(modalId: string) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }

  function showExito(mensaje: string) {
    const msgEl = document.getElementById('modal-exito-empresa-msg');
    if (msgEl) msgEl.textContent = mensaje;
    showModal('modal-exito-empresa');
    setTimeout(() => hideModal('modal-exito-empresa'), 2500);
  }

  function renderTablaEmpresas() {
    const tbody = document.getElementById('tabla-empresas');
    if (!tbody) return;

    const empresas = getEmpresas();
    const sedes = getSedes();
    const modelos = getModelos();
    
    tbody.innerHTML = '';

    if (empresas.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="px-6 py-8 text-center text-gray-500">
            No hay empresas registradas. Haz clic en "Nueva Empresa" para agregar una.
          </td>
        </tr>
      `;
      return;
    }

    empresas.forEach((empresa: any) => {
      const sedesCount = sedes.filter((s: any) => s.empresa_id === empresa.id).length;
      const modelosCount = modelos.filter((m: any) => m.empresa_id === empresa.id).length;

      const tr = document.createElement('tr');
      tr.className = 'hover:bg-blue-50 transition';
      tr.innerHTML = `
        <td class="px-6 py-4 text-sm font-medium text-gray-900">${empresa.nombre}</td>
        <td class="px-6 py-4 text-sm text-gray-600">${empresa.nit || 'N/A'}</td>
        <td class="px-6 py-4 text-sm text-gray-600">
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            ${sedesCount} sede${sedesCount !== 1 ? 's' : ''}
          </span>
        </td>
        <td class="px-6 py-4 text-sm text-gray-600">
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
            ${modelosCount} modelo${modelosCount !== 1 ? 's' : ''}
          </span>
        </td>
        <td class="px-6 py-4 text-sm space-x-3">
          <button class="btn-editar-empresa text-blue-600 hover:text-blue-800 font-semibold" data-id="${empresa.id}">
            Editar
          </button>
          <button class="btn-eliminar-empresa text-red-600 hover:text-red-800 font-semibold" data-id="${empresa.id}">
            Eliminar
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Event listeners para los botones
    document.querySelectorAll('.btn-editar-empresa').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = (e.target as HTMLElement).getAttribute('data-id');
        if (id) editarEmpresa(id);
      });
    });

    document.querySelectorAll('.btn-eliminar-empresa').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = (e.target as HTMLElement).getAttribute('data-id');
        if (id) confirmarEliminarEmpresa(id);
      });
    });
  }

  function nuevaEmpresa() {
    const form = document.getElementById('form-empresa-modal') as HTMLFormElement;
    const title = document.getElementById('modal-empresa-title');
    
    if (form) form.reset();
    if (title) title.textContent = 'Nueva Empresa';
    
    (document.getElementById('empresa-modal-id') as HTMLInputElement).value = '';
    showModal('modal-empresa');
  }

  function editarEmpresa(id: string) {
    const empresas = getEmpresas();
    const empresa = empresas.find((e: any) => e.id === id);
    
    if (!empresa) return;

    const title = document.getElementById('modal-empresa-title');
    if (title) title.textContent = 'Editar Empresa';

    (document.getElementById('empresa-modal-id') as HTMLInputElement).value = empresa.id;
    (document.getElementById('empresa-modal-nombre') as HTMLInputElement).value = empresa.nombre;
    (document.getElementById('empresa-modal-nit') as HTMLInputElement).value = empresa.nit || '';
    (document.getElementById('empresa-modal-nit-norm') as HTMLInputElement).value = empresa.nit_norm || '';

    showModal('modal-empresa');
  }

  let empresaIdToDelete: string | null = null;

  function confirmarEliminarEmpresa(id: string) {
    empresaIdToDelete = id;
    showModal('modal-confirmar-eliminar');
  }

  function eliminarEmpresa() {
    if (!empresaIdToDelete) return;

    const empresas = getEmpresas();
    const empresasFiltradas = empresas.filter((e: any) => e.id !== empresaIdToDelete);
    
    saveEmpresas(empresasFiltradas);
    renderTablaEmpresas();
    hideModal('modal-confirmar-eliminar');
    showExito('Empresa eliminada correctamente');
    
    empresaIdToDelete = null;
  }

  // Inicialización
  (function initEmpresasCRUD() {
    // Inicializar localStorage si es necesario
    if (!localStorage.getItem('scm_empresas')) {
      const empresasIniciales = (window as any).__SCM_EMPRESAS_INIT?.empresas || [];
      localStorage.setItem('scm_empresas', JSON.stringify(empresasIniciales));
    }

    renderTablaEmpresas();

    // Event listeners
    document.getElementById('btn-nueva-empresa')?.addEventListener('click', nuevaEmpresa);
    
    document.getElementById('modal-empresa-close')?.addEventListener('click', () => {
      hideModal('modal-empresa');
    });
    
    document.getElementById('btn-cancelar-empresa')?.addEventListener('click', () => {
      hideModal('modal-empresa');
    });

    // Auto-calcular NIT normalizado
    document.getElementById('empresa-modal-nit')?.addEventListener('input', (e) => {
      const nit = (e.target as HTMLInputElement).value;
      const nitNorm = normalizarNIT(nit);
      (document.getElementById('empresa-modal-nit-norm') as HTMLInputElement).value = nitNorm;
    });

    // Submit del formulario
    document.getElementById('form-empresa-modal')?.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const id = (document.getElementById('empresa-modal-id') as HTMLInputElement).value;
      const nombre = (document.getElementById('empresa-modal-nombre') as HTMLInputElement).value.trim();
      const nit = (document.getElementById('empresa-modal-nit') as HTMLInputElement).value.trim();
      const nit_norm = normalizarNIT(nit);

      if (!nombre || !nit) return;

      const empresas = getEmpresas();

      if (id) {
        // Editar empresa existente
        const index = empresas.findIndex((e: any) => e.id === id);
        if (index !== -1) {
          empresas[index] = {
            id: empresas[index].id, // Mantener el ID original
            nombre,
            nit,
            nit_norm
          };
          saveEmpresas(empresas);
          showExito('Empresa actualizada correctamente');
        }
      } else {
        // Crear nueva empresa
        const nuevaEmpresa = {
          id: Date.now().toString(),
          nombre,
          nit,
          nit_norm
        };
        empresas.push(nuevaEmpresa);
        saveEmpresas(empresas);
        showExito('Empresa creada correctamente');
      }

      hideModal('modal-empresa');
      const form = document.getElementById('form-empresa-modal') as HTMLFormElement;
      if (form) form.reset();
      renderTablaEmpresas();
    });

    // Confirmación de eliminación
    document.getElementById('btn-confirmar-eliminar')?.addEventListener('click', eliminarEmpresa);
    document.getElementById('btn-cancelar-eliminar')?.addEventListener('click', () => {
      hideModal('modal-confirmar-eliminar');
      empresaIdToDelete = null;
    });

    // Cerrar modal de éxito
    document.getElementById('modal-exito-empresa-ok')?.addEventListener('click', () => {
      hideModal('modal-exito-empresa');
    });

    // Escuchar cambios en los datos
    window.addEventListener('scm-data-changed', (e: any) => {
      if (e.detail?.key === 'scm_empresas' || e.detail?.key === 'scm_sedes' || e.detail?.key === 'scm_modelos') {
        renderTablaEmpresas();
      }
    });
  })();
</script>

